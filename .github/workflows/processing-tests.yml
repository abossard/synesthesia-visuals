name: Processing Sketches Validation

on:
  push:
    branches: [main, master]
    paths:
      - 'processing-vj/**'
      - '.github/workflows/processing-tests.yml'
  pull_request:
    branches: [main, master]
    paths:
      - 'processing-vj/**'
      - '.github/workflows/processing-tests.yml'

jobs:
  validate:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Java 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
      
      - name: Download and install Processing
        run: |
          # Download Processing 4.3 for Linux
          wget -q https://github.com/processing/processing4/releases/download/processing-1293-4.3/processing-4.3-linux-x64.tgz
          tar xzf processing-4.3-linux-x64.tgz
          echo "$PWD/processing-4.3" >> $GITHUB_PATH
      
      - name: Install virtual framebuffer
        run: |
          sudo apt-get update
          sudo apt-get install -y xvfb
      
      - name: Validate Processing sketches (build only)
        run: |
          # Find all Processing sketches and validate them
          SKETCHES_DIR="processing-vj/examples"
          
          if [ -d "$SKETCHES_DIR" ]; then
            for sketch_dir in "$SKETCHES_DIR"/*/; do
              sketch_name=$(basename "$sketch_dir")
              main_file="$sketch_dir$sketch_name.pde"
              
              if [ -f "$main_file" ]; then
                echo "Validating: $sketch_name"
                
                # Create output directory
                output_dir="/tmp/processing-build/$sketch_name"
                mkdir -p "$output_dir"
                
                # Build the sketch (validates syntax)
                # Note: Some sketches may fail due to missing libraries (Syphon, oscP5)
                # We attempt build but allow failures for library-dependent sketches
                xvfb-run -a ./processing-4.3/processing-java \
                  --sketch="$PWD/$sketch_dir" \
                  --output="$output_dir" \
                  --build 2>&1 || {
                    echo "Warning: $sketch_name build had issues (may need external libraries)"
                  }
              fi
            done
            echo "Sketch validation complete"
          else
            echo "No sketches directory found at $SKETCHES_DIR"
          fi
      
      - name: Check for basic syntax errors in PDE files
        run: |
          # Simple syntax validation - check for common issues
          find processing-vj -name "*.pde" -type f | while read pde_file; do
            echo "Checking: $pde_file"
            
            # Check for matching braces (basic)
            open_braces=$(grep -o '{' "$pde_file" | wc -l)
            close_braces=$(grep -o '}' "$pde_file" | wc -l)
            
            if [ "$open_braces" -ne "$close_braces" ]; then
              echo "Warning: Mismatched braces in $pde_file (open: $open_braces, close: $close_braces)"
            fi
            
            # Check for matching parentheses
            open_parens=$(grep -o '(' "$pde_file" | wc -l)
            close_parens=$(grep -o ')' "$pde_file" | wc -l)
            
            if [ "$open_parens" -ne "$close_parens" ]; then
              echo "Warning: Mismatched parentheses in $pde_file (open: $open_parens, close: $close_parens)"
            fi
          done
          echo "Basic syntax check complete"
